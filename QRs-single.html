<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor URL a QR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
<div class="max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">Convertidor URL a QR</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- CONFIG -->
        <div class="bg-white rounded-lg shadow-lg p-6 space-y-6">
            <h2 class="text-xl font-bold text-gray-800">Configuración</h2>

            <div>
                <label class="block text-sm font-semibold text-gray-700">URL</label>
                <input id="urlInput" type="text" placeholder="https://ejemplo.com"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <span class="text-xs text-gray-500">Largo: <span id="urlLength">0</span> caracteres</span>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700">Logo QR</label>
                <input id="logoInput" type="file" accept="image/*"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <label class="text-xs font-semibold text-gray-600 mt-2 block">
                    Tamaño Logo: <span id="logoSizeLabel">25</span>%
                </label>
                <input id="logoSize" type="range" min="20" max="35" value="25" class="w-full">
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700">Color QR</label>
                <div class="flex gap-2">
                    <input id="qrColor" type="color" value="#000000" class="w-12 h-10 border rounded">
                    <input id="qrColorHex" type="text" value="#000000"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
            </div>

            <div class="bg-blue-50 p-3 rounded-lg">
                <p class="text-sm text-gray-600">Corrección: <span id="errorLevel" class="font-bold text-blue-600">M</span></p>
                <p class="text-xs text-gray-500 mt-1">La versión se ajusta automáticamente.</p>
            </div>

            <div class="flex gap-2">
                <button onclick="generateQR()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    Generar QR
                </button>
                <button onclick="resetForm()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">
                    Reset
                </button>
            </div>
        </div>

        <!-- TEXTO -->
        <div class="bg-white rounded-lg shadow-lg p-6 space-y-6">
            <h2 class="text-xl font-bold text-gray-800">Texto</h2>

            <div>
                <label class="block text-sm font-semibold text-gray-700">Contenido</label>
                <textarea id="textContent" placeholder="Texto opcional"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none h-20 focus:ring-2 focus:ring-blue-500"></textarea>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700">Posición</label>
                <div class="flex gap-4 mt-1">
                    <label class="flex items-center gap-2">
                        <input type="radio" name="textPosition" value="top">
                        <span class="text-sm">Arriba</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="radio" name="textPosition" value="bottom" checked>
                        <span class="text-sm">Abajo</span>
                    </label>
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700">Color</label>
                <div class="flex gap-2">
                    <input id="textColor" type="color" value="#000000" class="w-12 h-10 border rounded">
                    <input id="textColorHex" type="text" value="#000000"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700">Fuente</label>
                <select id="textFont"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option>Arial</option>
                    <option>Georgia</option>
                    <option>Times New Roman</option>
                    <option>Courier New</option>
                    <option>Verdana</option>
                    <option>Trebuchet MS</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700">
                    Tamaño: <span id="textSizeLabel">16</span>px
                </label>
                <input id="textSize" type="range" min="8" max="40" value="16" class="w-full">
            </div>
        </div>

        <!-- CARD -->
        <div class="bg-white rounded-lg shadow-lg p-6 space-y-6">
            <h2 class="text-xl font-bold text-gray-800">Card</h2>

            <div>
                <label class="block text-sm font-semibold text-gray-700">Color Borde</label>
                <div class="flex gap-2">
                    <input id="borderColor" type="color" value="#000000" class="w-12 h-10 border rounded">
                    <input id="borderColorHex" type="text" value="#000000"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-gray-700">
                    Grosor Borde: <span id="borderWidthLabel">2</span>px
                </label>
                <input id="borderWidth" type="range" min="0" max="12" value="2" class="w-full">
            </div>

            <label class="flex items-center gap-2">
                <input id="shadowEnabled" type="checkbox" class="w-4 h-4">
                <span class="text-sm font-semibold text-gray-700">Habilitar sombra</span>
            </label>

            <div id="shadowOptions" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700">Color Sombra</label>
                    <div class="flex gap-2">
                        <input id="shadowColor" type="color" value="#000000" class="w-12 h-10 border rounded">
                        <input id="shadowColorHex" type="text" value="#000000"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700">
                        Opacidad sombra: <span id="shadowOpacityLabel">30</span>%
                    </label>
                    <input id="shadowOpacity" type="range" min="0" max="100" value="30" class="w-full">
                </div>
            </div>

            <label class="flex items-center gap-2">
                <input id="bgTransparent" type="checkbox" class="w-4 h-4">
                <span class="text-sm font-semibold text-gray-700">Fondo transparente</span>
            </label>

            <div id="bgColorOptions">
                <label class="block text-sm font-semibold text-gray-700">Color Fondo</label>
                <div class="flex gap-2">
                    <input id="bgColor" type="color" value="#ffffff" class="w-12 h-10 border rounded">
                    <input id="bgColorHex" type="text" value="#ffffff"
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
            </div>

            <div class="flex gap-2">
                <button id="downloadPngBtn" onclick="downloadPNG()"
                        class="hidden flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                    Descargar PNG
                </button>
                <button id="downloadPdfBtn" onclick="downloadPDF()"
                        class="hidden flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                    Descargar PDF
                </button>
            </div>
        </div>
    </div>

    <div class="mt-8 bg-white rounded-lg shadow-lg p-8 flex justify-center">
        <canvas id="canvas" class="max-w-full border-4 border-gray-200 rounded" style="max-height: 600px;"></canvas>
    </div>
</div>

<script>
const state = {
    url: '',
    logoUrl: null,
    logoSize: 25,
    qrColor: '#000000',
    textContent: '',
    textPosition: 'bottom',
    textColor: '#000000',
    textSize: 16,
    textFont: 'Arial',
    borderColor: '#000000',
    borderWidth: 2,
    shadowEnabled: false,
    shadowColor: '#000000',
    shadowOpacity: 0.3,
    bgColor: '#ffffff',
    bgTransparent: false,
    qrSize: 400,
    errorLevel: 'M'
};

// ---------- UTILIDADES ----------
function clampHex(value) {
    return /^#[0-9A-Fa-f]{6}$/.test(value) ? value : '#000000';
}

// ---------- EVENTOS ----------
urlInput.addEventListener('input', e => {
    state.url = e.target.value.trim();
    urlLength.textContent = state.url.length;
});

logoSize.addEventListener('input', e => {
    state.logoSize = +e.target.value;
    logoSizeLabel.textContent = state.logoSize;
});

logoInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => state.logoUrl = ev.target.result;
    reader.readAsDataURL(file);
});

qrColor.addEventListener('input', e => {
    state.qrColor = e.target.value;
    qrColorHex.value = state.qrColor;
});
qrColorHex.addEventListener('input', e => {
    state.qrColor = clampHex(e.target.value);
    qrColor.value = state.qrColor;
    qrColorHex.value = state.qrColor;
});

textContent.addEventListener('input', e => state.textContent = e.target.value);

document.querySelectorAll('input[name="textPosition"]').forEach(radio => {
    radio.addEventListener('change', e => state.textPosition = e.target.value);
});

textColor.addEventListener('input', e => {
    state.textColor = e.target.value;
    textColorHex.value = state.textColor;
});
textColorHex.addEventListener('input', e => {
    state.textColor = clampHex(e.target.value);
    textColor.value = state.textColor;
    textColorHex.value = state.textColor;
});

textFont.addEventListener('change', e => state.textFont = e.target.value);

textSize.addEventListener('input', e => {
    state.textSize = +e.target.value;
    textSizeLabel.textContent = state.textSize;
});

borderColor.addEventListener('input', e => {
    state.borderColor = e.target.value;
    borderColorHex.value = state.borderColor;
});
borderColorHex.addEventListener('input', e => {
    state.borderColor = clampHex(e.target.value);
    borderColor.value = state.borderColor;
    borderColorHex.value = state.borderColor;
});

borderWidth.addEventListener('input', e => {
    state.borderWidth = +e.target.value;
    borderWidthLabel.textContent = state.borderWidth;
});

shadowEnabled.addEventListener('change', e => {
    state.shadowEnabled = e.target.checked;
    shadowOptions.classList.toggle('hidden', !state.shadowEnabled);
});

shadowColor.addEventListener('input', e => {
    state.shadowColor = e.target.value;
    shadowColorHex.value = state.shadowColor;
});
shadowColorHex.addEventListener('input', e => {
    state.shadowColor = clampHex(e.target.value);
    shadowColor.value = state.shadowColor;
    shadowColorHex.value = state.shadowColor;
});

shadowOpacity.addEventListener('input', e => {
    state.shadowOpacity = +e.target.value / 100;
    shadowOpacityLabel.textContent = e.target.value;
});

bgTransparent.addEventListener('change', e => {
    state.bgTransparent = e.target.checked;
    bgColorOptions.classList.toggle('hidden', state.bgTransparent);
});

bgColor.addEventListener('input', e => {
    state.bgColor = e.target.value;
    bgColorHex.value = state.bgColor;
});
bgColorHex.addEventListener('input', e => {
    state.bgColor = clampHex(e.target.value);
    bgColor.value = state.bgColor;
    bgColorHex.value = state.bgColor;
});

// ---------- GENERAR QR ----------
function generateQR() {
    if (!state.url) {
        alert('Por favor ingresa una URL válida.');
        return;
    }

    let level = 'M';
    if (state.logoSize >= 30) level = 'H';
    else if (state.logoSize >= 25) level = 'Q';
    else if (state.logoSize >= 20) level = 'M';
    else level = 'L';

    state.errorLevel = level;
    errorLevel.textContent = level;

    const qr = qrcode(0, level); // versión automática → evita overflow
    qr.addData(state.url);
    qr.make();

    const modules = qr.getModuleCount();
    const padding = 20;
    const canvasSize = state.qrSize + padding * 2;

    const baseCanvas = document.createElement('canvas');
    baseCanvas.width = canvasSize;
    baseCanvas.height = canvasSize;
    const ctx = baseCanvas.getContext('2d');

    if (!state.bgTransparent) {
        ctx.fillStyle = state.bgColor;
        ctx.fillRect(0, 0, canvasSize, canvasSize);
    }

    const tile = state.qrSize / modules;

    for (let r = 0; r < modules; r++) {
        for (let c = 0; c < modules; c++) {
            ctx.fillStyle = qr.isDark(r, c) ? state.qrColor : (state.bgTransparent ? 'rgba(0,0,0,0)' : state.bgColor);
            ctx.fillRect(padding + c * tile, padding + r * tile, tile, tile);
        }
    }

    if (state.logoUrl) {
        const img = new Image();
        img.onload = () => {
            const logoSizePx = (state.qrSize * state.logoSize) / 100;
            const x = (canvasSize - logoSizePx) / 2;
            const y = (canvasSize - logoSizePx) / 2;

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x - 8, y - 8, logoSizePx + 16, logoSizePx + 16);
            ctx.drawImage(img, x, y, logoSizePx, logoSizePx);

            drawTextAndFinalize(baseCanvas);
        };
        img.src = state.logoUrl;
    } else {
        drawTextAndFinalize(baseCanvas);
    }
}

// ---------- TEXTO + BORDES + SOMBRA ----------
function drawTextAndFinalize(canvas) {
    let finalCanvas = canvas;

    if (state.textContent.trim()) {
        const fontSize = state.textSize;
        const padding = 20;
        const textHeight = fontSize + padding * 2;

        const newCanvas = document.createElement('canvas');
        newCanvas.width = canvas.width;
        newCanvas.height = canvas.height + textHeight;
        const ctx = newCanvas.getContext('2d');

        if (!state.bgTransparent) {
            ctx.fillStyle = state.bgColor;
            ctx.fillRect(0, 0, newCanvas.width, newCanvas.height);
        }

        ctx.font = `${fontSize}px ${state.textFont}`;
        ctx.fillStyle = state.textColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if (state.textPosition === 'top') {
            ctx.fillText(state.textContent, newCanvas.width / 2, textHeight / 2);
            ctx.drawImage(canvas, 0, textHeight);
        } else {
            ctx.drawImage(canvas, 0, 0);
            ctx.fillText(state.textContent, newCanvas.width / 2, canvas.height + textHeight / 2);
        }

        finalCanvas = newCanvas;
    }

    const padding = state.shadowEnabled ? 20 : 0;
    const displayCanvas = document.getElementById('canvas');
    displayCanvas.width = finalCanvas.width + padding * 2;
    displayCanvas.height = finalCanvas.height + padding * 2;
    const ctx = displayCanvas.getContext('2d');

    if (!state.bgTransparent) {
        ctx.fillStyle = state.bgColor;
        ctx.fillRect(0, 0, displayCanvas.width, displayCanvas.height);
    }

    if (state.shadowEnabled) {
        ctx.shadowColor = state.shadowColor;
        ctx.shadowBlur = 15;
        ctx.globalAlpha = state.shadowOpacity;
    }

    ctx.drawImage(finalCanvas, padding, padding);
    ctx.globalAlpha = 1;

    if (state.borderWidth > 0) {
        ctx.strokeStyle = state.borderColor;
        ctx.lineWidth = state.borderWidth;
        ctx.strokeRect(padding, padding, finalCanvas.width, finalCanvas.height);
    }

    downloadPngBtn.classList.remove('hidden');
    downloadPdfBtn.classList.remove('hidden');
}

// ---------- DESCARGAS ----------
function downloadPNG() {
    const canvas = document.getElementById('canvas');
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = `qr-${Date.now()}.png`;
    link.click();
}

function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const canvas = document.getElementById('canvas');
    const imgData = canvas.toDataURL('image/png');

    const pdf = new jsPDF({
        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
        unit: 'pt',
        format: [canvas.width, canvas.height]
    });

    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
    pdf.save(`qr-${Date.now()}.pdf`);
}

// ---------- RESET ----------
function resetForm() {
    Object.assign(state, {
        url: '',
        logoUrl: null,
        logoSize: 25,
        qrColor: '#000000',
        textContent: '',
        textPosition: 'bottom',
        textColor: '#000000',
        textSize: 16,
        textFont: 'Arial',
        borderColor: '#000000',
        borderWidth: 2,
        shadowEnabled: false,
        shadowColor: '#000000',
        shadowOpacity: 0.3,
        bgColor: '#ffffff',
        bgTransparent: false,
        errorLevel: 'M'
    });

    urlInput.value = '';
    urlLength.textContent = '0';
    logoInput.value = '';
    logoSize.value = 25;
    logoSizeLabel.textContent = '25';
    qrColor.value = '#000000';
    qrColorHex.value = '#000000';
    errorLevel.textContent = 'M';
    textContent.value = '';
    document.querySelector('input[name="textPosition"][value="bottom"]').checked = true;
    textColor.value = '#000000';
    textColorHex.value = '#000000';
    textFont.value = 'Arial';
    textSize.value = 16;
    textSizeLabel.textContent = '16';
    borderColor.value = '#000000';
    borderColorHex.value = '#000000';
    borderWidth.value = 2;
    borderWidthLabel.textContent = '2';
    shadowEnabled.checked = false;
    shadowOptions.classList.add('hidden');
    shadowColor.value = '#000000';
    shadowColorHex.value = '#000000';
    shadowOpacity.value = 30;
    shadowOpacityLabel.textContent = '30';
    bgTransparent.checked = false;
    bgColorOptions.classList.remove('hidden');
    bgColor.value = '#ffffff';
    bgColorHex.value = '#ffffff';

    const canvas = document.getElementById('canvas');
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    downloadPngBtn.classList.add('hidden');
    downloadPdfBtn.classList.add('hidden');
}
</script>
</body>
</html>
